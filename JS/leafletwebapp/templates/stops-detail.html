<html>
        {% load leaflet_tags %}
        {% load static %}
<head>
    <meta charset="UTF-8">   
    
       
    

    {% leaflet_css %}
    {{ form.media.css }}
    {% leaflet_js %}
    
    <link rel="stylesheet" type="text/css" href="{% static 'dist/style.css' %}"/>
    <link rel="stylesheet" href="{% static 'dist/leaflet-liveupdate.css' %}" />
    <link rel="stylesheet" href="{% static 'dist/leaflet-messagebox.css' %}" />
    <link rel="stylesheet" href="{% static 'dist/MarkerCluster.Default.css' %}" />
    <link rel="stylesheet" href="{% static 'dist/MarkerCluster.css' %}" />



    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.11/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.11/js/select2.min.js"></script> -->
    <!-- <link rel="stylesheet" href="{% static 'easy_select2/easy_select2/css/easy_select2.css' %}"/>
    <script src="{% static 'easy_select2/easy_select2/vendor/jquery/jquery.min.js' %}"></script>
    <script src="{% static 'easy_select2/easy_select2/js/easy_select2.js' %}"></script> -->
    <!-- <script src="{% static 'easy_select2/easy_select2/vendor/jquery/jquery.min.js' %}"></script> -->


    <script src="{% static 'dist/leaflet-realtime.min.js' %}"></script>
    <script src="{% static 'dist/leaflet-realtime.js' %}"></script>
    <script src="{% static 'dist/leaflet-liveupdate.js' %}"></script>
    <script src="{% static 'dist/leaflet-messagebox.js' %}"></script>


        <style>.leaflet-container-default {
            height: 80%;
            width: 100%;
        }</style>
        <script type="text/javascript" src="{% static 'dist/leaflet.ajax.js' %}" >	</script>

</head>
<body>
    {{form.media.js}}

            <script type="text/javascript">

iconsmap = {}

function returnicon(iconnumber)
{
  var busurl = "/static/bus_icon/"+iconnumber+".png";
 return new L.Icon({
iconUrl: busurl,
iconSize: [30, 45],
iconAnchor: [12, 45],
popupAnchor: [1, -34],
shadowSize: [45, 45]
})
}
function getnewicon(vehicle_id)
{ 
        if( typeof getnewicon.counter == 'undefined' ) {
          getnewicon.counter = 0;
      }
      if(vehicle_id in iconsmap)
      {
        
      }
      else{
        iconsmap[vehicle_id] = returnicon(getnewicon.counter%13);
        getnewicon.counter++;
      }
        
        return iconsmap[vehicle_id];
}
           function map_points(map,options)
            {
                //particular-bus
                // console.log(mypara)
                var datapoints = new L.GeoJSON.AJAX("{% url 'stops:particular-bus' vehicle_id='DL1PD2596' %}",
                            //   var datapoints = new L.GeoJSON.AJAX("{% url 'stops:all-buses' %}",
                {
			pointToLayer: function (feature, latlng) {
                return L.marker(latlng, {
                    icon: L.icon({
                        // iconUrl: "static/img/bus_blue_point.png",
                        markerColor: 'green'

                    }),
                    // title: feature.properties.stop_name,
                    title: feature.properties.vehicle_id,
                    riseOnHover: true
                });
            },
			onEachFeature: function(feature,layer){
				// layer.bindPopup(feature.properties.stop_name.toString());
                layer.bindPopup(feature.properties.vehicle_id.toString());
			}
		});
		//datasets.addTo(map);
        
		datapoints.addTo(map);
            }



            function map_init(map, options) {
                var datapoints = new L.GeoJSON.AJAX("{% url 'stops:filtered-buses' %}",
                {
			pointToLayer: function (feature, latlng) {
                return L.marker(latlng, {
                    icon:getnewicon(feature.properties.vehicle_id),
                    title: feature.properties.vehicle_id,
                    riseOnHover: true
                });
            },
			onEachFeature: function(feature,layer){
				// layer.bindPopup(feature.properties.stop_name.toString());
                layer.bindPopup("Bus Number: "+feature.properties.vehicle_id.toString() +
                 "<br>"+"Speed: " + feature.properties.speed.toString() +
                 "<br>"+"Route id: " + feature.properties.route_id.toString()
                 );
			}
		});
        // alert(datapoints.length);
        datapoints.addTo(map);

			L.control.liveupdate ({
				update_map: function () {
        // datapoints.addTo(map);
        datapoints.refresh("{% url 'stops:filtered-buses' %}");
					
				},
				position: 'topleft',
				interval: 5000
			})
			.addTo(map)
			.stopUpdating();
            }           
        </script>
    
    <div id="upright">
        <!-- <h1>{{ stops.stop_name }}</h1>
        <h1>{{ buses.vehicle_id}}</h1> -->

        <!-- {% leaflet_map "gis" callback="map_points"  %} -->
        {% leaflet_map "gis" callback="map_init" %}
        <div id="below">
            <textarea id='classic'></textarea>
                <!-- <input type="textarea" placeholder="Enter Query here" width="100%" id="classic" height="100%"> -->
                <input type="submit" value="Execute">
             </div>
    </div>
   

    <div id="upleft">  

        <button type="submit"  onclick="location.href='{% url 'playback:playback' %}'" >PlayBack</button>

        <form action="/" method="post" >
            {% csrf_token %}
            {{ form.as_p}}
            <input type="submit" name="filterbus" value="Filter">
            
        </form>
      
    </div>
   

    <!-- {% leaflet_map "main" %} -->
</body>
</html>
